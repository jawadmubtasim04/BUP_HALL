<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - BUP Hall Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-btn { padding: 0.75rem 1.5rem; border-bottom: 3px solid transparent; transition: all 0.3s ease; cursor: pointer; }
        .tab-btn.active { border-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .admin-view { display: none; }
        .admin-view.active { display: block; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
            <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">
                Logout
            </button>
        </nav>
    </header>

    <!-- Tabs Navigation -->
    <div class="bg-white shadow-sm mb-8">
        <div class="container mx-auto flex">
            <button data-view="seat-management" class="tab-btn active">Seat Management</button>
            <button data-view="meal-overview" class="tab-btn">Meal Overview</button>
            <button data-view="complaints" class="tab-btn">Complaints</button>
            <button data-view="notices" class="tab-btn">Post Notice</button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-6 pb-8">
        <!-- View 1: Seat Management -->
        <div id="seat-management" class="admin-view active">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Student Seat Requests</h2>
            <div class="bg-white p-4 rounded-lg shadow"><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th></tr></thead><tbody id="seat-requests-table" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>
        </div>

        <!-- View 2: Meal Overview -->
        <div id="meal-overview" class="admin-view">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Tomorrow's Meal Count</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="bg-white p-6 rounded-lg shadow text-center"><h3 class="text-lg font-medium text-gray-500">Breakfast</h3><p id="breakfast-count" class="text-5xl font-bold text-blue-600 mt-2">0</p></div><div class="bg-white p-6 rounded-lg shadow text-center"><h3 class="text-lg font-medium text-gray-500">Lunch</h3><p id="lunch-count" class="text-5xl font-bold text-green-600 mt-2">0</p></div><div class="bg-white p-6 rounded-lg shadow text-center"><h3 class="text-lg font-medium text-gray-500">Dinner</h3><p id="dinner-count" class="text-5xl font-bold text-red-600 mt-2">0</p></div></div>
            <div class="mt-12"><h2 class="text-2xl font-semibold mb-4 text-gray-800">Tomorrow's Individual Meal Plan</h2><div class="bg-white p-4 rounded-lg shadow"><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th><th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">B</th><th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">L</th><th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">D</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monthly Meals (B/L/D)</th></tr></thead><tbody id="individual-meals-table" class="bg-white divide-y divide-gray-200"></tbody></table></div></div></div>
        </div>

        <!-- View 3: Complaints -->
        <div id="complaints" class="admin-view">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Student Complaints</h2>
            <div id="complaints-container" class="space-y-4"></div>
        </div>

        <!-- View 4: Post Notice -->
        <div id="notices" class="admin-view">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Post a New Hall Notice</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <form id="notice-form">
                    <div class="mb-4"><label for="notice-title" class="block text-sm font-medium text-gray-700">Title</label><input type="text" id="notice-title" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></div>
                    <div><label for="notice-content" class="block text-sm font-medium text-gray-700">Content</label><textarea id="notice-content" rows="5" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></textarea></div>
                    <button type="submit" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Post Notice</button>
                </form>
            </div>
        </div>
    </main>

    <script>
        // --- GLOBAL STATE & AUTH CHECK ---
        const token = sessionStorage.getItem('token');
        const userRole = sessionStorage.getItem('userRole');
        if (!token || userRole !== 'admin') {
            sessionStorage.clear();
            window.location.href = '/login.html';
        }

        // --- UI ELEMENT DECLARATIONS ---
        const logoutBtn = document.getElementById('logout-btn');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const adminViews = document.querySelectorAll('.admin-view');
        // Seat Management
        const seatTableBody = document.getElementById('seat-requests-table');
        // Meal Overview
        const breakfastCountEl = document.getElementById('breakfast-count');
        const lunchCountEl = document.getElementById('lunch-count');
        const dinnerCountEl = document.getElementById('dinner-count');
        const individualMealsTable = document.getElementById('individual-meals-table');
        // Complaints
        const complaintsContainer = document.getElementById('complaints-container');
        // Notices
        const noticeForm = document.getElementById('notice-form');

        // --- TAB SWITCHING LOGIC ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const targetViewId = button.dataset.view;
                adminViews.forEach(view => view.classList.toggle('active', view.id === targetViewId));
                
                // Load data for the selected tab
                if(targetViewId === 'seat-management') loadUsers();
                if(targetViewId === 'meal-overview') loadMealOverview();
                if(targetViewId === 'complaints') loadComplaints();
            });
        });

        // --- SEAT MANAGEMENT LOGIC ---
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users', { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Failed to fetch users.');
                const users = await response.json();
                renderUserTable(users);
            } catch (error) {
                seatTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">${error.message}</td></tr>`;
            }
        }

        function renderUserTable(users) {
            seatTableBody.innerHTML = '';
            users.sort((a, b) => (a.seatStatus === 'pending') ? -1 : 1);
            users.forEach(user => {
                const row = document.createElement('tr');
                let actionHtml = '<span>-</span>';
                if (user.seatStatus === 'pending') {
                    actionHtml = `<div class="flex items-center space-x-2"><input type="text" placeholder="A101" class="w-24 p-2 border-gray-300 rounded-md"><button class="bg-green-500 text-white px-3 py-2 rounded-md">Approve</button></div>`;
                }
                row.innerHTML = `<td class="px-6 py-4">${user.studentId}</td><td class="px-6 py-4">${user.seatStatus} ${user.seatNumber ? `(${user.seatNumber})` : ''}</td><td class="px-6 py-4">${actionHtml}</td>`;
                if (user.seatStatus === 'pending') {
                    row.querySelector('button').addEventListener('click', () => approveSeat(user._id, row.querySelector('input').value));
                }
                seatTableBody.appendChild(row);
            });
        }

        async function approveSeat(userId, seatNumber) {
            if (!seatNumber.trim()) return alert('Please provide a seat number.');
            try {
                const response = await fetch('/api/admin/approve-seat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ userId, seatNumber: seatNumber.trim().toUpperCase() })
                });
                const result = await response.json();
                alert(result.message);
                if (response.ok) loadUsers();
            } catch (error) {
                alert('Failed to approve seat.');
            }
        }

        // --- MEAL OVERVIEW LOGIC ---
        async function loadMealOverview() {
            try {
                const response = await fetch('/api/admin/meals-overview', { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Failed to fetch meal overview');
                const { summary, detailedPlans } = await response.json();
                breakfastCountEl.textContent = summary.breakfast;
                lunchCountEl.textContent = summary.lunch;
                dinnerCountEl.textContent = summary.dinner;
                individualMealsTable.innerHTML = '';
                if (detailedPlans.length === 0) {
                    individualMealsTable.innerHTML = '<tr><td colspan="5" class="text-center py-4">No meals planned for tomorrow.</td></tr>';
                    return;
                }
                detailedPlans.forEach(item => {
                    const row = document.createElement('tr');
                    const tick = '✔️'; const cross = '❌';
                    const monthly = item.monthlyTotals;
                    const monthlyString = `B:${monthly.b}, L:${monthly.l}, D:${monthly.d}`;
                    row.innerHTML = `<td class="px-6 py-4">${item.studentId}</td><td class="px-6 py-4 text-center">${item.plan.breakfast ? tick : cross}</td><td class="px-6 py-4 text-center">${item.plan.lunch ? tick : cross}</td><td class="px-6 py-4 text-center">${item.plan.dinner ? tick : cross}</td><td class="px-6 py-4 font-semibold">${monthlyString}</td>`;
                    individualMealsTable.appendChild(row);
                });
            } catch (error) {
                alert(error.message);
            }
        }

        // --- COMPLAINTS LOGIC ---
        async function loadComplaints() {
            try {
                const response = await fetch('/api/admin/complaints', { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Failed to fetch complaints');
                const complaints = await response.json();
                complaintsContainer.innerHTML = '';
                if (complaints.length === 0) {
                    complaintsContainer.innerHTML = '<p>No complaints found.</p>';
                    return;
                }
                complaints.sort((a,b) => (a.status === 'unresolved') ? -1 : 1);
                complaints.forEach(c => {
                    const card = document.createElement('div');
                    card.className = `bg-white p-4 rounded-lg shadow border-l-4 ${c.status === 'resolved' ? 'border-green-500' : 'border-red-500'}`;
                    const isResolved = c.status === 'resolved';
                    card.innerHTML = `<div class="flex justify-between items-start"><div><p class="font-semibold">Student ID: ${c.studentId}</p><p class="text-sm text-gray-600 mt-2">${c.complaint}</p></div><div class="text-right"><p class="text-xs text-gray-500">${new Date(c.timestamp).toLocaleString()}</p><button class="mt-2 text-sm font-bold py-1 px-3 rounded ${isResolved ? 'bg-gray-200 text-gray-500' : 'bg-green-500 text-white'}" ${isResolved ? 'disabled' : ''}>${isResolved ? 'Resolved' : 'Mark as Resolved'}</button></div></div>`;
                    if (!isResolved) {
                        card.querySelector('button').addEventListener('click', () => resolveComplaint(c._id));
                    }
                    complaintsContainer.appendChild(card);
                });
            } catch (error) {
                complaintsContainer.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            }
        }

        async function resolveComplaint(complaintId) {
            try {
                const response = await fetch('/api/admin/resolve-complaint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ complaintId })
                });
                const result = await response.json();
                alert(result.message);
                if (response.ok) loadComplaints();
            } catch (error) {
                alert('Failed to resolve complaint.');
            }
        }

        // --- NOTICE LOGIC ---
        noticeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('notice-title').value;
            const content = document.getElementById('notice-content').value;
            try {
                const response = await fetch('/api/admin/notices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ title, content })
                });
                const result = await response.json();
                alert(result.message);
                if (response.ok) noticeForm.reset();
            } catch (error) {
                alert('Failed to post notice.');
            }
        });

        // --- GENERAL EVENT LISTENERS ---
        logoutBtn.addEventListener('click', () => {
            sessionStorage.clear();
            window.location.href = '/login.html';
        });

        // --- INITIAL LOAD ---
        document.addEventListener('DOMContentLoaded', loadUsers);
    </script>
</body>
</html>
